<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">  

  <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css">
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

  <!-- Add a reference to the Azure Maps Services Module JavaScript file. -->
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas-service.min.js"></script>
  <script src="azure-maps-geolocation.min.js" type="text/javascript"></script>
  <title>Cosmic-Azlearn</title>
  <style>
    #chatView {
      width: 100vw;    
    }

    #globeView {
      width: 100vw;
      height: calc(60vh - 3.5rem);
    }

    body {
      font-size: 1.2vw;
    }

    span.blink {
      display: block;
      width: 15px;
      height: 15px;

      background-color: #0fcc45;
      opacity: 0.7;
      border-radius: 50%;

      animation: blink 1s linear infinite;
    }

    textarea {
      width: 100%;
      height: 100%;
      -webkit-box-sizing: border-box;
      /* Safari/Chrome, other WebKit */
      -moz-box-sizing: border-box;
      /* Firefox, other Gecko */
      box-sizing: border-box;
      /* Opera/IE 8+ */
    }

    @keyframes blink {
      100% {
        transform: scale(2, 2);
        opacity: 0;
      }
    }
    .pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #00cae9;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -20px 0 0 -20px;
        }

.pin:after {
             content: "";
             width: 14px;
             height: 14px;
             margin: 8px 0 0 8px;
             background: #e6e6e6;
             position: absolute;
             border-radius: 50%;
            }

.bounce {
            animation-name: bounce;
            animation-fill-mode: both;
            animation-duration: 1s;
        }

.pulse {
            background: #d6d4d4;
            border-radius: 50%;
            height: 14px;
            width: 14px;
            position: absolute;
            left: 50%;
            top: 50%;
            margin: 11px 0px 0px -12px;
            transform: rotateX(55deg);
            z-index: -2;
        }

.pulse:after {
                content: "";
                border-radius: 50%;
                height: 40px;
                width: 40px;
                position: absolute;
                margin: -13px 0 0 -13px;
                animation: pulsate 1s ease-out;
                animation-iteration-count: infinite;
                opacity: 0;
                box-shadow: 0 0 1px 2px #00cae9;
                animation-delay: 1.1s;
            }

@keyframes pulsate {
            0% {
                transform: scale(0.1, 0.1);
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: scale(1.2, 1.2);
                opacity: 0;
            }
                  }

@keyframes bounce {
            0% {
                opacity: 0;
                transform: translateY(-2000px) rotate(-45deg);
            }

            60% {
                opacity: 1;
                transform: translateY(30px) rotate(-45deg);
            }

            80% {
                transform: translateY(-10px) rotate(-45deg);
            }

            100% {
                transform: translateY(0) rotate(-45deg);
  }}

:root {
  --white: #fff;
  --black: #000;
  --bg: #f8f8f8;
  --grey: #999;
  --dark: #1a1a1a;
  --light: #e6e6e6;
  --wrapper: 1000px;
  --blue: #00b0ff;
}
ul {
  list-style-type: none;
}

.wrapper {
  position: relative;
  left: 16%;
  width: var(--wrapper);
  height: 800px;
  transform: translate(-50%, 0);
}

.container {
  position: relative;
  top: 50%;
  left: 60%;
  width: 90%;
  height: 75%;
  background-color: var(--white);
  transform: translate(-50%, -50%);
}
.container .left {
  overflow: scroll;
  float: left;
  width: 37.6%;
  height: 100%;
  border: 1px solid var(--light);
  background-color: var(--white);
}
.container .left .top {
  position: relative;
  width: 100%;
  height: 96px;
  padding: 29px;
}
.container .left .top:after {
  position: absolute;
  bottom: 0;
  left: 50%;
  display: block;
  width: 80%;
  height: 1px;
  content: "";
  background-color: var(--light);
  transform: translate(-50%, 0);
}
.container .left input {
  float: left;
  width: 188px;
  height: 42px;
  padding: 0 15px;
  border: 1px solid var(--light);
  background-color: #eceff1;
  border-radius: 21px;
  font-family: "Source Sans Pro", sans-serif;
  font-weight: 400;
}
.container .left input:focus {
  outline: none;
}
.container .left a.search {
  display: block;
  float: left;
  width: 42px;
  height: 42px;
  margin-left: 10px;
  border: 1px solid var(--light);
  background-color: var(--blue);
  background-image: url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/name-type.png");
  background-repeat: no-repeat;
  background-position: top 12px left 14px;
  border-radius: 50%;
}
.container .left .people {
  margin-left: -1px;
  border-right: 1px solid var(--light);
  border-left: 1px solid var(--light);
  width: calc(100% + 2px);
}
.container .left .people .person {
  position: relative;
  width: 100%;
  padding: 12px 10% 16px;
  cursor: pointer;
  background-color: var(--white);
}
.container .left .people .person:after {
  position: absolute;
  bottom: 0;
  left: 50%;
  display: block;
  width: 80%;
  height: 1px;
  content: "";
  background-color: var(--light);
  transform: translate(-50%, 0);
}
.container .left .people .person img {
  float: left;
  width: 40px;
  height: 40px;
  margin-right: 12px;
  border-radius: 50%;
  -o-object-fit: cover;
     object-fit: cover;
}
.container .left .people .person .name {
  font-size: 14px;
  line-height: 22px;
  color: var(--dark);
  font-family: "Source Sans Pro", sans-serif;
  font-weight: 600;
}
.container .left .people .person .time {
  font-size: 14px;
  position: absolute;
  top: 16px;
  right: 10%;
  padding: 0 0 5px 5px;
  color: var(--grey);
  background-color: var(--white);
}
.container .left .people .person .preview {
  font-size: 14px;
  display: inline-block;
  overflow: hidden !important;
  width: 70%;
  white-space: nowrap;
  text-overflow: ellipsis;
  color: var(--grey);
}
.container .left .people .person.active, .container .left .people .person:hover {
  margin-top: -1px;
  margin-left: -1px;
  padding-top: 13px;
  border: 0;
  background-color: var(--blue);
  width: calc(100% + 2px);
  padding-left: calc(10% + 1px);
}
.container .left .people .person.active span, .container .left .people .person:hover span {
  color: var(--white);
  background: transparent;
}
.container .left .people .person.active:after, .container .left .people .person:hover:after {
  display: none;
}
.container .right {
  position: relative;
  float: left;
  width: 62.4%;
  height: 100%;
}
.container .right .top {
  width: 100%;
  height: 47px;
  padding: 15px 29px;
  background-color: #eceff1;
}
.container .right .top span {
  font-size: 15px;
  color: var(--grey);
}
.container .right .top span .name {
  color: var(--dark);
  font-family: "Source Sans Pro", sans-serif;
  font-weight: 600;
}
.container .right .chat {
  position: relative;
  display: none;
  overflow: hidden;
  padding: 0 35px 92px;
  border-width: 1px 1px 1px 0;
  border-style: solid;
  border-color: var(--light);
  height: calc(100% - 48px);
  justify-content: flex-end;
  flex-direction: column;
}
.container .right .chat.active-chat {
  display: block;
  display: flex;
}
.container .right .chat.active-chat .bubble {
  transition-timing-function: cubic-bezier(0.4, -0.04, 1, 1);
}
.container .right .chat.active-chat .bubble:nth-of-type(1) {
  -webkit-animation-duration: 0.15s;
          animation-duration: 0.15s;
}
.container .right .chat.active-chat .bubble:nth-of-type(2) {
  -webkit-animation-duration: 0.3s;
          animation-duration: 0.3s;
}
.container .right .chat.active-chat .bubble:nth-of-type(3) {
  -webkit-animation-duration: 0.45s;
          animation-duration: 0.45s;
}
.container .right .chat.active-chat .bubble:nth-of-type(4) {
  -webkit-animation-duration: 0.6s;
          animation-duration: 0.6s;
}
.container .right .chat.active-chat .bubble:nth-of-type(5) {
  -webkit-animation-duration: 0.75s;
          animation-duration: 0.75s;
}
.container .right .chat.active-chat .bubble:nth-of-type(6) {
  -webkit-animation-duration: 0.9s;
          animation-duration: 0.9s;
}
.container .right .chat.active-chat .bubble:nth-of-type(7) {
  -webkit-animation-duration: 1.05s;
          animation-duration: 1.05s;
}
.container .right .chat.active-chat .bubble:nth-of-type(8) {
  -webkit-animation-duration: 1.2s;
          animation-duration: 1.2s;
}
.container .right .chat.active-chat .bubble:nth-of-type(9) {
  -webkit-animation-duration: 1.35s;
          animation-duration: 1.35s;
}
.container .right .chat.active-chat .bubble:nth-of-type(10) {
  -webkit-animation-duration: 1.5s;
          animation-duration: 1.5s;
}
.container .right .write {
  position: absolute;
  bottom: 29px;
  left: 30px;
  height: 42px;
  padding-left: 8px;
  border: 1px solid var(--light);
  background-color: #eceff1;
  width: calc(100% - 58px);
  border-radius: 5px;
}
.container .right .write input {
  font-size: 16px;
  float: left;
  width: 347px;
  height: 40px;
  padding: 0 10px;
  color: var(--dark);
  border: 0;
  outline: none;
  background-color: #eceff1;
  font-family: "Source Sans Pro", sans-serif;
  font-weight: 400;
}
.container .right .write .write-link.attach:before {
  display: inline-block;
  float: left;
  width: 20px;
  height: 42px;
  content: "";
  background-image: url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/attachment.png");
  background-repeat: no-repeat;
  background-position: center;
}
.container .right .write .write-link.smiley:before {
  display: inline-block;
  float: left;
  width: 20px;
  height: 42px;
  content: "";
  background-image: url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/smiley.png");
  background-repeat: no-repeat;
  background-position: center;
}
.container .right .write .write-link.send:before {
  display: inline-block;
  float: left;
  width: 20px;
  height: 42px;
  margin-left: 11px;
  content: "";
  background-image: url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/send.png");
  background-repeat: no-repeat;
  background-position: center;
}
.container .right .bubble {
  font-size: 16px;
  position: relative;
  display: inline-block;
  clear: both;
  margin-bottom: 8px;
  padding: 13px 14px;
  vertical-align: top;
  border-radius: 5px;
}
.container .right .bubble:before {
  position: absolute;
  top: 19px;
  display: block;
  width: 8px;
  height: 6px;
  content: " ";
  transform: rotate(29deg) skew(-35deg);
}
.container .right .bubble.you {
  float: left;
  color: var(--white);
  background-color: var(--blue);
  align-self: flex-start;
  -webkit-animation-name: slideFromLeft;
          animation-name: slideFromLeft;
}
.container .right .bubble.you:before {
  left: -3px;
  background-color: var(--blue);
}
.container .right .bubble.me {
  float: right;
  color: var(--dark);
  background-color: #eceff1;
  align-self: flex-end;
  -webkit-animation-name: slideFromRight;
          animation-name: slideFromRight;
}
.container .right .bubble.me:before {
  right: -3px;
  background-color: #eceff1;
}
.container .right .conversation-start {
  position: relative;
  width: 100%;
  margin-bottom: 27px;
  text-align: center;
}
.container .right .conversation-start span {
  font-size: 14px;
  display: inline-block;
  color: var(--grey);
}
.container .right .conversation-start span:before, .container .right .conversation-start span:after {
  position: absolute;
  top: 10px;
  display: inline-block;
  width: 30%;
  height: 1px;
  content: "";
  background-color: var(--light);
}
.container .right .conversation-start span:before {
  left: 0;
}
.container .right .conversation-start span:after {
  right: 0;
}

@keyframes slideFromLeft {
  0% {
    margin-left: -200px;
    opacity: 0;
  }
  100% {
    margin-left: 0;
    opacity: 1;
  }
}
@-webkit-keyframes slideFromLeft {
  0% {
    margin-left: -200px;
    opacity: 0;
  }
  100% {
    margin-left: 0;
    opacity: 1;
  }
}
@keyframes slideFromRight {
  0% {
    margin-right: -200px;
    opacity: 0;
  }
  100% {
    margin-right: 0;
    opacity: 1;
  }
}
@-webkit-keyframes slideFromRight {
  0% {
    margin-right: -200px;
    opacity: 0;
  }
  100% {
    margin-right: 0;
    opacity: 1;
  }
}
  </style>
</head>

<body onload="GetMap()">
  <nav class="navbar navbar-expand navbar-light bg-light">
    <div id="online" style="display: none;" class="online-indicator">
      <span class="blink mr-2"></span>
    </div>
    <span class="navbar-brand">Cosmic AzLearn</span>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" id="url" target="_blank" href="#"></a>
        </li>
      </ul>
      <div id="speakerDashboard" style="display: none;">
        <button id="startBtn" onclick="onStartSession()" type="button" class="btn btn-success mr-1">Start</button>
        <button id="stopBtn" disabled onclick="onStopSession()" type="button" class="btn btn-danger">Stop</button>
      </div>
      <div id="audienceDashboard" style="display: none;">
        <button id="joinBtn" onclick="onJoinSession()" type="button" class="btn btn-success mr-1">Join</button>
        <button id="leaveBtn" disabled onclick="onLeaveSession()" type="button" class="btn btn-danger">Leave</button>
      </div>
    </div>
  </nav>
  <div class="modal fade" id="inputName" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Please input your name</h5>
        </div>
        <div class="modal-body">
          <input id="username" class="form-control" type="text" placeholder="Your name" v-model="name"
            v-on:keypress.enter="setName">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" v-bind:disabled="!name" data-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
  <div style="overflow: hidden;">
    <div id="globeView" class="col"></div>
    <div id="chatView" class="col">
      <div class="wrapper">
        <div class="container">
            <div class="left">
                <div class="top">
                    <input type="text" placeholder="Search" />
                    <a href="javascript:;" class="search"></a>
                </div>
                <ul class="people">
                    <li class="person" data-chat="person1">
                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/thomas.jpg" alt="" />
                        <span class="name">Thomas Bangalter</span>
                        <span class="time">2:09 PM</span>
                        <span class="preview">I was wondering...</span>
                    </li>
                    <li class="person" data-chat="person2">
                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/dog.png" alt="" />
                        <span class="name">Dog Woofson</span>
                        <span class="time">1:44 PM</span>
                        <span class="preview">I've forgotten how it felt before</span>
                    </li>
                    <li class="person" data-chat="person3">
                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/louis-ck.jpeg" alt="" />
                        <span class="name">Louis CK</span>
                        <span class="time">2:09 PM</span>
                        <span class="preview">But we’re probably gonna need a new carpet.</span>
                    </li>
                    <li class="person" data-chat="person4">
                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/bo-jackson.jpg" alt="" />
                        <span class="name">Bo Jackson</span>
                        <span class="time">2:09 PM</span>
                        <span class="preview">It’s not that bad...</span>
                    </li>
                    <li class="person" data-chat="person5">
                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/michael-jordan.jpg" alt="" />
                        <span class="name">Michael Jordan</span>
                        <span class="time">2:09 PM</span>
                        <span class="preview">Wasup for the third time like is 
    you blind bitch</span>
                    </li>
                    <li class="person" data-chat="person6">
                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/382994/drake.jpg" alt="" />
                        <span class="name">Drake</span>
                        <span class="time">2:09 PM</span>
                        <span class="preview">howdoyoudoaspace</span>
                    </li>
                </ul>
            </div>
            <div class="right">
                <div class="top"><span>To: <span class="name">Dog Woofson</span></span></div>
                <div class="chat" data-chat="person1">
                    <div class="conversation-start">
                        <span>Today, 6:48 AM</span>
                    </div>
                    <div class="bubble you">
                        Hello,
                    </div>
                    <div class="bubble you">
                        it's me.
                    </div>
                    <div class="bubble you">
                        I was wondering...
                    </div>
                </div>
                <div class="chat" data-chat="person2">
                    <div class="conversation-start">
                        <span>Today, 5:38 PM</span>
                    </div>
                    <div class="bubble you">
                        Hello, can you hear me?
                    </div>
                    <div class="bubble you">
                        I'm in California dreaming
                    </div>
                    <div class="bubble me">
                        ... about who we used to be.
                    </div>
                    <div class="bubble me">
                        Are you serious?
                    </div>
                    <div class="bubble you">
                        When we were younger and free...
                    </div>
                    <div class="bubble you">
                        I've forgotten how it felt before
                    </div>
                </div>
                <div class="chat" data-chat="person3">
                    <div class="conversation-start">
                        <span>Today, 3:38 AM</span>
                    </div>
                    <div class="bubble you">
                        Hey human!
                    </div>
                    <div class="bubble you">
                        Umm... Someone took a shit in the hallway.
                    </div>
                    <div class="bubble me">
                        ... what.
                    </div>
                    <div class="bubble me">
                        Are you serious?
                    </div>
                    <div class="bubble you">
                        I mean...
                    </div>
                    <div class="bubble you">
                        It’s not that bad...
                    </div>
                    <div class="bubble you">
                        But we’re probably gonna need a new carpet.
                    </div>
                </div>
                <div class="chat" data-chat="person4">
                    <div class="conversation-start">
                        <span>Yesterday, 4:20 PM</span>
                    </div>
                    <div class="bubble me">
                        Hey human!
                    </div>
                    <div class="bubble me">
                        Umm... Someone took a shit in the hallway.
                    </div>
                    <div class="bubble you">
                        ... what.
                    </div>
                    <div class="bubble you">
                        Are you serious?
                    </div>
                    <div class="bubble me">
                        I mean...
                    </div>
                    <div class="bubble me">
                        It’s not that bad...
                    </div>
                </div>
                <div class="chat" data-chat="person5">
                    <div class="conversation-start">
                        <span>Today, 6:28 AM</span>
                    </div>
                    <div class="bubble you">
                        Wasup
                    </div>
                    <div class="bubble you">
                        Wasup
                    </div>
                    <div class="bubble you">
                        Wasup for the third time like is <br />you blind bitch
                    </div>
    
                </div>
                <div class="chat" data-chat="person6">
                    <div class="conversation-start">
                        <span>Monday, 1:27 PM</span>
                    </div>
                    <div class="bubble you">
                        So, how's your new phone?
                    </div>
                    <div class="bubble you">
                        You finally have a smartphone :D
                    </div>
                    <div class="bubble me">
                        Drake?
                    </div>
                    <div class="bubble me">
                        Why aren't you answering?
                    </div>
                    <div class="bubble you">
                        howdoyoudoaspace
                    </div>
                </div>
                <div class="write">
                    <a href="javascript:;" class="write-link attach"></a>
                    <input type="text" />
                    <a href="javascript:;" class="write-link smiley"></a>
                    <a href="javascript:;" class="write-link send"></a>
                </div>
            </div>
        </div>
    </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>  
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <script>
    document.querySelector('.chat[data-chat=person2]').classList.add('active-chat')
document.querySelector('.person[data-chat=person2]').classList.add('active')

let friends = {
    list: document.querySelector('ul.people'),
    all: document.querySelectorAll('.left .person'),
    name: ''
  },
  chat = {
    container: document.querySelector('.container .right'),
    current: null,
    person: null,
    name: document.querySelector('.container .right .top .name')
  }

friends.all.forEach(f => {
  f.addEventListener('mousedown', () => {
    f.classList.contains('active') || setAciveChat(f)
  })
});

function setAciveChat(f) {
  friends.list.querySelector('.active').classList.remove('active')
  f.classList.add('active')
  chat.current = chat.container.querySelector('.active-chat')
  chat.person = f.getAttribute('data-chat')
  chat.current.classList.remove('active-chat')
  chat.container.querySelector('[data-chat="' + chat.person + '"]').classList.add('active-chat')
  friends.name = f.querySelector('.name').innerText
  chat.name.innerHTML = friends.name
}
  </script>
  <script>

    var SpeechSDK;
    var recognizer;
    var speechDisplayArea = document.getElementById('speechDisplayArea');
    var editorDisplayArea = document.getElementById('editor');
    var speechRecognizedText = "";
    let webSocket;
    let sessionId;
    var map, geolocationControl;

        function GetMap() {            
           /* map = new atlas.Map("globeView", {
                view: 'Auto',                
                authOptions: {                    
                    //authType: 'anonymous',
                    //clientId: 'd0e4165a-a456-4cb0-8862-96d5a21e01f6',
                    authType:'subscriptionKey',
                    subscriptionKey:'vZWbTX24nzFpth4LZSJLKQK2D4IPrF8M6yuMlpWz_8E',
                    getToken: async function (resolve, reject, map) {                                                                      
                      let res = await fetch("https://func-cosmic.azurewebsites.net/api/azureMapsToken", {method:'GET',                       
                      mode:"cors",
                        headers: {
                          Referer:'https://wonderful-river-07ec3e210.1.azurestaticapps.net'
                        }});
                      //let res = await fetch("/azmapstoken");
                      console.log("token",res);
                      let data = await res.text();  
                      console.log("token text",data);
                      return resolve(data);                     
                    }
                }
            });*/
            map = new atlas.Map("globeView", {
                //Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps
                authOptions: {
                  authType:'subscriptionKey',
                    subscriptionKey:'4c5wlP9ya7T5Eq_CJ3ooOx_4HRON8SWdO6Bo4-1wj0g',
                },
                style: "grayscale_light",
                center: [78.8718, 21.7679],
                zoom: 3.5
            });                        

            map.events.add('ready', function () {
                map.controls.add([
                    new atlas.control.StyleControl(),
                    new atlas.control.GeolocationControl({
                        style: 'auto'
                    })
                ], {
                    position: 'top-right'
                });
            });
            setTimeout(setMapToUserLocation,6000);
        }
        function setMapToUserLocation() {    
    navigator.geolocation.getCurrentPosition(function(position) {

      console.log("latitude",position.coords.latitude);
      console.log("longitude",position.coords.longitude);
        
        map.setCamera({
          
            center: [position.coords.longitude, position.coords.latitude],
            zoom: 11 + 1
        });
        var marker = new atlas.HtmlMarker({
                    htmlContent: "<div><div class='pin bounce'></div><div class='pulse'></div></div>",
                    position: [position.coords.longitude, position.coords.latitude]
                });
                map.markers.add(marker);                
    }, function(error) {        
        switch (error.code) {
            case error.PERMISSION_DENIED:
                alert('User denied the request for geolocation.');
                break;
            case error.POSITION_UNAVAILABLE:
                alert('Position information is unavailable.');
                break;
            case error.TIMEOUT:
                alert('The request to get user position timed out.');
                break;
            case error.UNKNOWN_ERROR:
                alert('An unknown error occurred.');
                break;
        }
    });
    return false;
  }
    function updateStreamId(id) {
      let u = document.querySelector('#url');
      let url = `${location.protocol}//${location.host}${location.pathname}#${id}`;
      u.setAttribute('href', url);
      u.textContent = url;
    }

    function updateStatus(status) {
      var onlineDiv = document.getElementById('online');
      if (status == 'Connected')
        onlineDiv.style.display = "block";
      else
        onlineDiv.style.display = "none";
    }
    function updateSpeakerStatus(status) {
      var audiencedashboard = document.getElementById('audienceDashboard');
      var speakerDashboard = document.getElementById('speakerDashboard');


      if (status == 'Connected') {
        audiencedashboard.style.display = "none";
        speakerDashboard.style.display = "block";
        speechDisplayArea.readOnly = false;
      }
      else {
        audiencedashboard.style.display = "block";
        speakerDashboard.style.display = "none";
        speechDisplayArea.readOnly = true;
      }
    }

    function updateAudienceStatus(status) {
      var audiencedashboard = document.getElementById('audienceDashboard');
      var speakerDashboard = document.getElementById('speakerDashboard');

      speechDisplayArea.readOnly = true;

      if (status == 'Connected') {
        audiencedashboard.style.display = "block";
        speakerDashboard.style.display = "none";
      }
      else {
        audiencedashboard.style.display = "none";
        speakerDashboard.style.display = "block";
      }
    }

    async function initialize(url, isSpeaker) {

      let res = await fetch(url);
      let data = await res.json();
      updateStreamId(data.id);
      sessionId = data.id;

      let ws = new WebSocket(data.url, 'json.webpubsub.azure.v1');
      webSocket = ws;
      let editor = createEditor(document.querySelector('#editor'), true);

      if (isSpeaker) {
        let speechTokenData = await fetch('/speech-token');
        let response = await speechTokenData.json();
        let token = response.token;


        let speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, response.region);
        speechConfig.SpeechRecognitionLanguage = "en-US";


        var audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

        recognizer.recognizing = recognizerCallback.bind(this);

        recognizer.recognized = holdRecognized.bind(this);

        recognizer.startContinuousRecognitionAsync();

      }

      return [ws, editor, data.id];
    }


    function holdRecognized(s, e) {
      speechRecognizedText += e.result.text != undefined ? e.result.text + "\r\n" : "";
      speechDisplayArea.value = speechRecognizedText;
    }

    function recognizerCallback(s, e) {
      speechDisplayArea.value = e.result.text != undefined ? speechRecognizedText + " " + e.result.text : speechRecognizedText;
      speechDisplayArea.scrollTop = speechDisplayArea.scrollHeight;
      webSocket.send(JSON.stringify({
        type: 'sendToGroup',
        group: sessionId,
        dataType: 'json',
        data: {
          type: 'speech',
          content: speechDisplayArea.value
        }
      }));
    };

    function joinGroup(ws, group) {
      ws.send(JSON.stringify({
        type: 'joinGroup',
        group: group,
        ackId: 1
      }));
    }

    function sendToGroup(ws, group, data) {
      ws.send(JSON.stringify({
        type: 'sendToGroup',
        group: group,
        dataType: 'json',
        data: data
      }));
    }

    function stopStream() {
      recognizer.stopContinuousRecognitionAsync(function () {
        recognizer.close();
        recognizer = undefined;
      }, function (err) {
        recognizer.close();
        recognizer = undefined;
      })
    }

    async function startStream() {      
      let [ws, editor, id] = await initialize('/negotiate', true);
      let changes = [];
      let content = '';
      let version = 0;
      function flush() {
        if (changes.length === 0) return;
        sendToGroup(ws, id, {
          type: 'delta',
          version: version++,
          changes: changes
        });
        changes = [];
        content = editor.getValue();
      }

      setTimeout(ws.onopen = () => {
        updateStatus('Connected');
        setInterval(() => flush(), 200);
        joinGroup(ws, `${id}-control`);
        editor.on('change', e => changes.push(e));
        editor.setReadOnly(false);
      }, 1000);

      ws.onmessage = e => {
        let data = JSON.parse(e.data);
        if (data.data === 'sync') sendToGroup(ws, id, {
          type: 'full',
          version: version,
          content: content
        });
      }
    }

    async function onStartSession() {
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      speechDisplayArea.style.display = "block";
      editorDisplayArea.style.display = "block";
      startStream();
    }

    async function onJoinSession() {
      document.getElementById('joinBtn').disabled = true;
      document.getElementById('leaveBtn').disabled = false;
      speechDisplayArea.style.display = "block";
      editorDisplayArea.style.display = "block";
      updateStatus('Connected');
      watch(location.hash.slice(1));
    }

    async function onLeaveSession() {
      document.getElementById('joinBtn').disabled = true;
      document.getElementById('leaveBtn').disabled = false;
      speechDisplayArea.style.display = "none";
      editorDisplayArea.style.display = "none";
      updateStatus('Disconnected');
    }

    async function onStopSession() {
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      speechDisplayArea.style.display = "none";
      editorDisplayArea.style.display = "none";
      updateStatus('Disconnected');
      stopStream();
    }

    async function watch(id) {
      let version = -1;
      let [ws, editor] = await initialize(`/negotiate?id=${id}`, false)
      ws.onopen = () => {
        joinGroup(ws, id);
      };

      ws.onmessage = e => {
        let data = JSON.parse(e.data);
        if (data.type === 'ack' && data.success) sendToGroup(ws, `${id}-control`, 'sync');
        else if (data.type === 'message') {
          switch (data.data.type) {
            case 'delta':
              if (data.data.version !== version + 1)
                data.data.changes.forEach(c => editor.getSession().getDocument().applyDelta(c));
              version = data.data.version;
              break;
            case 'full':
              if (version >= data.data.version) break;
              editor.setValue(data.data.content);
              version = data.data.version;
              break;
            case 'speech':
              if (version >= data.data.version) break;
              speechDisplayArea.value = data.data.content;
              speechDisplayArea.scrollTop = speechDisplayArea.scrollHeight;
              version = data.data.version;
              break;
          }
        }
      }
    }

      if (!!window.SpeechSDK) {
      SpeechSDK = window.SpeechSDK;
    }    
  </script>
</body>

</html>